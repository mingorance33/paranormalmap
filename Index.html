<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Radar Paranormal Estable</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; padding: 0; background: #000; color: #0f0; font-family: monospace; }
    #map { height: 100vh; width: 100vw; z-index: 1; }
    #interface {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(0, 20, 0, 0.9); padding: 15px;
      border: 1px solid #0f0; pointer-events: none;
    }
    .status-ok { color: #0f0; }
    .status-error { color: #f00; font-weight: bold; }
  </style>
</head>
<body>

  <div id="interface">
    <div>SISTEMA: <span id="status">INICIALIZANDO...</span></div>
    <div>PROVINCIA: <span id="prov">-</span></div>
    <div>HALLAZGOS: <span id="count">0</span></div>
  </div>
  <div id="map"></div>

  <script>
    // Configuración inicial
    var map = L.map('map').setView([37.38, -5.98], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    var markersLayer = L.layerGroup().addTo(map);

    // 1. Obtener Provincia por Geocodificación
    async function getProvincia(lat, lon) {
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
        const d = await r.json();
        return d.address.province || d.address.state || "Sevilla";
      } catch (e) { return "Sevilla"; }
    }

    // 2. Buscar referencias reales en Wikipedia/Web (Simulado por API rápida)
    async function getPopularidad(nombre, prov) {
      // Usamos la API de Wikipedia como termómetro de "fama"
      const url = `https://es.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(nombre + " " + prov)}&format=json&origin=*`;
      try {
        const r = await fetch(url);
        const d = await r.json();
        return d.query.searchinfo.totalhits; // Devuelve cuántas páginas hablan de esto
      } catch (e) { return 0; }
    }

    async function escanear() {
      const status = document.getElementById('status');
      const provEl = document.getElementById('prov');
      const countEl = document.getElementById('count');

      status.innerText = "BUSCANDO...";
      status.className = "status-ok";

      const centro = map.getCenter();
      const provincia = await getProvincia(centro.lat, centro.lng);
      provEl.innerText = provincia;

      const b = map.getBounds();
      const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;

      // Query optimizada para evitar errores 429/500
      const query = `[out:json][timeout:15];(
        node["name"~"Cortijo|Hacienda|Monasterio|Fábrica|Cementerio|Torre",i](${bbox});
        way["name"~"Cortijo|Hacienda|Monasterio|Fábrica|Cementerio|Torre",i](${bbox});
      );out center;`;

      try {
        const response = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
        
        if (!response.ok) throw new Error();
        
        const data = await response.json();
        markersLayer.clearLayers();
        let encontrados = 0;

        for (let el of data.elements) {
          const nombre = el.tags.name;
          const lat = el.lat || el.center.lat;
          const lon = el.lon || el.center.lon;

          // COTEJO: Solo si tiene referencias en internet
          const nRefs = await getPopularidad(nombre, provincia);

          // FILTRO: Solo lugares con menciones (paranormales o históricas)
          if (nRefs > 0 || nombre.toLowerCase().includes("diablo") || nombre.toLowerCase().includes("misterio")) {
            encontrados++;
            L.circleMarker([lat, lon], {
              radius: 10,
              fillColor: "#f00",
              color: "#fff",
              weight: 2,
              fillOpacity: 0.8
            }).addTo(markersLayer)
              .bindPopup(`
                <div style="color:#000">
                  <b>${nombre}</b><br>
                  <i>Provincia: ${provincia}</i><hr>
                  Referencias: <b>${nRefs}</b><br><br>
                  <a href="https://www.google.com/search?q=${encodeURIComponent(nombre + ' ' + provincia + ' paranormal')}" target="_blank">Investigar</a>
                </div>
              `);
          }
        }
        countEl.innerText = encontrados;
        status.innerText = "RADAR ACTIVO";
      } catch (err) {
        status.innerText = "ERROR DE CONEXIÓN (REINTENTANDO...)";
        status.className = "status-error";
        setTimeout(escanear, 5000); // Reintento automático
      }
    }

    // Evitar saturación: solo busca cuando el mapa se deja de mover
    let t;
    map.on('moveend', () => {
      clearTimeout(t);
      t = setTimeout(escanear, 1500);
    });

    escanear();
  </script>
</body>
</html>
